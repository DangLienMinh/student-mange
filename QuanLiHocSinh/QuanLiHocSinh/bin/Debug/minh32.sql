IF EXISTS (SELECT name FROM master.sys.databases WHERE name = N'QuanLyHocSinh')
BEGIN
DROP DATABASE QuanLyHocSinh
END
GO
create database QuanLyHocSinh
GO
USE QuanLyHocSinh
GO

create table QUYDINH (
   MAQD                 varchar(20)          not null,
   TENQD                nvarchar(20)          null,
   GIATRI               Nvarchar(50)           null,
   constraint PK_QUYDINH primary key nonclustered (MAQD)
)
GO

create table LOAIHANHKIEM (
   MALHK                varchar(15)              not null,
   TENLHK               nvarchar(20)          null,
   constraint PK_LOAIHANHKIEM primary key nonclustered (MALHK)
)
GO

create table HANHKIEM (
   MALHK                varchar(15)          not null,
   MAHS                 varchar(8)           not null,
   MANH                 varchar(6)           not null,
   MAHK                 varchar(10)          not null,
   constraint PK_HANHKIEM primary key (MALHK,MANH, MAHS, MAHK)
)
GO


create table LOAINGUOIDUNG (
   MALND                varchar(10)          not null,
   TENLND               nvarchar(20)          null,
   constraint PK_LOAINGUOIDUNG primary key nonclustered (MALND)
)
GO

create table NAMHOC (
   MANH                 varchar(6)           not null,
   TENNH                nvarchar(30)          null,
   constraint PK_NAMHOC primary key nonclustered (MANH)
)
GO

create table HOCKY (
   MANH                 varchar(6)           not null,
   MAHK                 varchar(10)          not null,
   TENHK				nvarchar(20)			null,
   constraint PK_HOCKY primary key nonclustered (MANH, MAHK)
)
GO

create table KHOI (
   MAKHOI               varchar(10)              not null,
   TENKHOI              nvarchar(15)          null,
   constraint PK_KHOI primary key nonclustered (MAKHOI)
)
GO

create table LOAIDIEM (
   MALD                 varchar(15)              not null, /* ld1, ld2,ld3,...*/
   TENLD                nvarchar(20)          null,
   HESOLD               char(1)           null,
   constraint PK_LOAIDIEM primary key nonclustered (MALD)
)
GO

create table MONHOC (
   MAMH                 varchar(10)           not null,
   TENMH                nvarchar(25)          null,
   SOTIET				VARCHAR(3)				NULL,
   constraint PK_MONHOC primary key nonclustered (MAMH)
)
GO


create table DIEM (
   STT                  int  identity(1,1)             not null,
   MALD                 varchar(15)              not null,
   MAHK                 varchar(10)              not null,
   MANH                 varchar(6)           not null,
   MAHS                 varchar(8)              not null,
   MAMH                 varchar(10)           not null,
   DIEMSO               varchar(4)           null,
   constraint PK_DIEM primary key nonclustered (STT)
)
GO

create table GIANGDAY (
   MAMH                 varchar(10)           not null,
   MAGV                 char(5)              not null,
   MANH                 varchar(6)           not null,
   MALOP                varchar(10)              not null,
   constraint PK_GIANGDAY primary key (MANH, MAMH, MAGV, MALOP)
)
go

create table GIAOVIEN (
   MAGV                 char(5)              not null,
   TENGV                nvarchar(50)          null,
   NGSINHGV             smalldatetime             null,
   GIOITINHGV           char(1)                  null,
   DIACHIGV             nvarchar(50)          null,
   DIENTHOAIGV          varchar(15)          null,
   HINHANHGV            varchar(200)         null,
   MABM					varchar(10)			 null,
   constraint PK_GIAOVIEN primary key nonclustered ( MAGV)
)
go

create table BOMON (
   MABM                 varchar(10)              not null,
   TENBM                nvarchar(50)          null,   
   constraint PK_BOMON primary key nonclustered ( MABM)
)
go

create table BAN (
   MABAN                varchar(10)          not null,
   TENBAN               nvarchar(50)          null,
   constraint PK_BAN primary key nonclustered (MABAN)
)
go

create table NGUOIDUNG(
   MAND                 char(5)              not null,
   MALND                varchar(10)          null,
   TENND                nvarchar(50)          null,
   TENDN                varchar(40)          null,
   MATKHAU              varchar(20)          null,
   constraint PK_NGUOIDUNG primary key nonclustered (MAND)
)
GO

create table HOCLOP (
   MAHS                 varchar(8)           not null,
   MANH                 varchar(6)           not null,
   MALOP                varchar(10)          not null,
   THOIGIANHIEULUC      smalldatetime             null,
   constraint PK_HOCLOP primary key (MAHS, MANH, MALOP)
)
GO

create table HOCSINH (
   MAHS                 varchar(8)              not null,
   TENHS                nvarchar(50)          null,
   NGSINHHS             smalldatetime             null,
   GIOITINHHS           char(1)                  null,
   DIACHIHS             nvarchar(50)          null,
   DIENTHOAIHS          varchar(15)          null,
   NGNHAPHOC            smalldatetime             null,
   HINHANHHS            varchar(200)         null,
   DANTOC               nvarchar(10)          null,
   constraint PK_HOCSINH primary key nonclustered ( MAHS)
)
GO


create table LOP (
   MALOP                varchar(10)          not null,
   MAKHOI               varchar(10)          not null,
   MANH                 varchar(6)           not null,
   MAGV                 char(5)              not null,
   TENLOP               nvarchar(20)          null,
   SISO                 varchar(3)           null,
   MABAN				VARCHAR(10)			NULL,	
   constraint PK_LOP primary key nonclustered (MALOP)
)
GO

alter table LOP
   add constraint FK_LOP_CUABAN_BAN foreign key (MABAN)
      references BAN (MABAN)
go

alter table HOCKY
   add constraint FK_HOCKY_THUOC_NAMHOC foreign key (MANH)
      references NAMHOC (MANH)on delete Cascade
go

alter table DIEM
   add constraint FK_DIEM_CHITIETDI_LOAIDIEM foreign key (MALD)
      references LOAIDIEM (MALD) on delete Cascade
go

alter table DIEM
   add constraint FK_DIEM_CO_MONHOC foreign key (MAMH)
      references MONHOC (MAMH) on delete Cascade
go

alter table DIEM
   add constraint FK_DIEM_CODIEM_HOCSINH foreign key ( MAHS)
      references HOCSINH ( MAHS) on delete Cascade
go

alter table DIEM
   add constraint FK_DAT_DIEM_DAT_DIEM4_HOCKY foreign key (MANH, MAHK)
      references HOCKY (MANH, MAHK) on delete Cascade
go

alter table GIANGDAY
   add constraint FK_GIANGDAY_GIANGDAY_MONHOC foreign key (MAMH)
      references MONHOC (MAMH) on delete Cascade
go

alter table GIANGDAY
   add constraint FK_GIANGDAY_GIANGDAY_NAMHOC foreign key (MANH)
      references NAMHOC (MANH) on delete Cascade
go

alter table GIANGDAY
   add constraint FK_GIANGDAY_GIANGDAY3_GIAOVIEN foreign key (MAGV)
      references GIAOVIEN (MAGV) 
go

alter table GIANGDAY
   add constraint FK_GIANGDAY_GIANGDAY4_LOP foreign key (MALOP)
      references LOP (MALOP) on delete Cascade
go


alter table HANHKIEM
   add constraint FK_HANHKIEM_COHANHKIEM_HOCSINH foreign key ( MAHS)
      references HOCSINH(MAHS) on delete Cascade
go

alter table HANHKIEM
   add constraint FK_DAT_HANH_DAT_HANHK_HOCKY foreign key (MANH, MAHK)
      references HOCKY (MANH, MAHK) on delete Cascade
go

alter table HANHKIEM
   add constraint FK_HANHKIEM_CO_HK_LOAIHANH foreign key (MALHK)
      references LOAIHANHKIEM (MALHK) on delete Cascade
go


alter table HOCLOP
   add constraint FK_HOCLOP_HOCLOP_HOCSINH foreign key (MAHS)
      references HOCSINH (MAHS) on delete Cascade
go

alter table HOCLOP
   add constraint FK_HOCLOP_HOCLOP3_LOP foreign key (MALOP)
      references LOP (MALOP) on delete Cascade
go

alter table HOCLOP
   add constraint FK_HOCLOP_HOCLOP_NAMHOC foreign key (MANH)
      references NAMHOC (MANH)  on delete CASCADE
go


alter table GIAOVIEN
   add constraint FK_GIAOVIEN_CUA_BOMON foreign key (MABM)
   references BOMON (MABM)  on delete CASCADE
go

alter table LOP
   add constraint FK_LOP_DAY_GIAOVIEN foreign key (MAGV)
      references GIAOVIEN (MAGV)  on delete CASCADE
go

alter table LOP
   add constraint FK_LOP_CUA_NAMHOC foreign key (MANH)
      references NAMHOC (MANH)
go


alter table LOP
   add constraint FK_LOP_CHUA_KHOI foreign key (MAKHOI)
      references KHOI (MAKHOI) on delete Cascade
go

alter table NGUOIDUNG
   add constraint FK_NGUOIDUN_LA_LOAINGUO foreign key (MALND)
      references LOAINGUOIDUNG (MALND) on delete Cascade
go

--====================================== QUYDINH =================================================

--SUA THONG TIN TRUONG
create proc SP_SuaTruongHoc
@TENTRUONG NVARCHAR(50),@DIACHI NVARCHAR(50),@DIENTHOAI NVARCHAR(50)  
AS
BEGIN
UPDATE QUYDINH SET GIATRI=@TENTRUONG WHERE MAQD='TenTruong'
UPDATE QUYDINH SET GIATRI=@DIACHI WHERE MAQD='DiaChi'
UPDATE QUYDINH SET GIATRI=@DIENTHOAI WHERE MAQD='DienThoai'
END
GO

--SUA THONG TIN SI SO
create proc SP_SuaSiSo
@SISOTT NVARCHAR(50),@SISOTD NVARCHAR(50) 
AS
BEGIN
UPDATE QUYDINH SET GIATRI=@SISOTT WHERE MAQD='SiSoTT'
UPDATE QUYDINH SET GIATRI=@SISOTD WHERE MAQD='SiSoTD'
END
GO

--SUA THONG TIN TUOI
create proc SP_SuaTuoi
@TUOITT NVARCHAR(50),@TUOITD NVARCHAR(50) 
AS
BEGIN
UPDATE QUYDINH SET GIATRI=@TUOITT WHERE MAQD='TuoiTT'
UPDATE QUYDINH SET GIATRI=@TUOITD WHERE MAQD='TuoiTD'
END
GO

--THONG TIN QUY DINH
create proc SP_ThongTinQuyDinh 
AS
BEGIN
SELECT GIATRI FROM QUYDINH
END
GO

--THONG TIN TUOI TOI THIEU
CREATE PROC SP_TuoiToiThieu
AS
BEGIN
	SELECT * FROM QUYDINH WHERE MAQD='TuoiTT'
END
GO

--THONG TIN TUOI TOI DA
CREATE PROC SP_TuoiToiDa
AS
BEGIN
	SELECT * FROM QUYDINH WHERE MAQD='TuoiTD'
END
GO
--====================================== HOCSINH =================================================
--THONG TIN HOC SINH
CREATE PROC SP_ThongTinHocSinh
AS
BEGIN
SELECT * FROM HOCSINH  
END
GO

--TEN HOC SINH THEO MAHS 
CREATE PROC SP_TenHocSinhMaHS
@MAHS VARCHAR(8)
AS
BEGIN
SELECT TENHS FROM HOCSINH WHERE MAHS=@MAHS
END
GO

--THEM HOC SINH
create proc SP_ThemHocSinh
@MAHS VARCHAR(8),@TENHS NVARCHAR(50),@NGSINHHS SMALLDATETIME,@GIOITINHHS CHAR(1),@DIACHIHS NVARCHAR(50),@DIENTHOAIHS VARCHAR(15),@NGNHAPHOC SMALLDATETIME,@HINHANHHS VARCHAR(200),@DANTOC NVARCHAR(10)
AS
BEGIN
INSERT INTO HOCSINH VALUES(@MAHS,@TENHS,@NGSINHHS,@GIOITINHHS,@DIACHIHS,@DIENTHOAIHS,@NGNHAPHOC,@HINHANHHS,@DANTOC)
END
GO

--SUA HOCSINH
create proc SP_SuaHocSinh
@MAHS VARCHAR(8),@TENHS NVARCHAR(50),@NGSINHHS SMALLDATETIME,@GIOITINHHS CHAR(1),@DIACHIHS NVARCHAR(50),@DIENTHOAIHS VARCHAR(15),@NGNHAPHOC SMALLDATETIME,@HINHANHHS VARCHAR(200),@DANTOC NVARCHAR(10)
AS
BEGIN
UPDATE HOCSINH SET TENHS=@TENHS,NGSINHHS=@NGSINHHS,GIOITINHHS=@GIOITINHHS,DIACHIHS=@DIACHIHS,DIENTHOAIHS=@DIENTHOAIHS,NGNHAPHOC=@NGNHAPHOC,HINHANHHS=@HINHANHHS,DANTOC=@DANTOC WHERE MAHS=@MAHS
END
GO

--XOA HOCSINH
CREATE PROC SP_XoaHocSinh
@MAHS VARCHAR(8)
AS
BEGIN
DELETE FROM HOCSINH WHERE MAHS=@MAHS
END
GO

--TIM THONG TIN HOC SINH THEO PHAN LOP
create proc SP_TimHocSinhChuyenLop
@MAHS VARCHAR(8)
AS
	BEGIN
	IF (EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE 
     TABLE_NAME = 'temp3'))
    BEGIN
        DROP TABLE temp3;
    end
    begin
        SELECT TOP(1) * INTO temp3 FROM HOCLOP WHERE MAHS=@MAHS 
		ORDER BY MAHS, MANH DESC,MALOP DESC,THOIGIANHIEULUC DESC 
    SELECT temp3.MAHS,TENHS,temp3.MANH,temp3.MALOP FROM HOCSINH INNER JOIN temp3 ON HOCSINH.MAHS=temp3.MAHS 
    END
	END
GO


--THONG TIN HOC SINH THEO LOP
CREATE PROC SP_ThongTinHocSinhTheoLop
@MANH VARCHAR(6),@MALOP VARCHAR(10)
AS
BEGIN
 IF (EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE 
     TABLE_NAME = 'temp'))
    BEGIN
        DROP TABLE temp;
    END
select a.MAHS,a.THOIGIANHIEULUC into temp FROM HOCLOP a WHERE a.THOIGIANHIEULUC IN(select max(thoigianhieuluc) from HOCLOP  group by manh,MAHS)
IF (EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE 
     TABLE_NAME = 'temp1'))
    BEGIN
        DROP TABLE temp1;
    END
select hoclop.MAHS,MALOP,MANH,HOCLOP.THOIGIANHIEULUC into temp1  from temp inner join HOCLOP on temp.mahs=HOCLOP.MAHS and temp.thoigianhieuluc=HOCLOP.THOIGIANHIEULUC
 and HOCLOP.THOIGIANHIEULUC=temp.THOIGIANHIEULUC
SELECT HOCSINH.MAHS,TENHS,NGSINHHS,GIOITINHHS,DIACHIHS,DIENTHOAIHS,DANTOC,NGNHAPHOC FROM HOCSINH,LOP,temp1 WHERE HOCSINH.MAHS=temp1.MAHS and LOP.MANH=temp1.MANH and LOP.MALOP=temp1.MALOP AND LOP.MANH=@MANH AND LOP.MALOP=@MALOP
END
GO

--TIM HOC SINH THEO TEN HOC SINH	
create proc SP_TimHocSinhTenHS
@TENHS NVARCHAR(50)
AS
	BEGIN
		SELECT MAHS,TENHS,NGSINHHS,GIOITINHHS,DIACHIHS,DIENTHOAIHS,DANTOC,NGNHAPHOC,HINHANHHS FROM HOCSINH  WHERE TENHS=@TENHS
	END
	GO

--TIM HOC SINH THEO MAHS		
create proc SP_TimHocSinhMaHS
@MAHS VARCHAR(8)
AS
	BEGIN
		SELECT MAHS,TENHS,NGSINHHS,GIOITINHHS,DIACHIHS,DIENTHOAIHS,DANTOC,NGNHAPHOC,HINHANHHS FROM HOCSINH  WHERE MAHS=@MAHS 
	END
	GO

--TIM HOC SINH THEO DAN TOC		
create proc SP_TimHocSinhDanToc
@DANTOC NVARCHAR(10)
AS
	BEGIN
		SELECT MAHS,TENHS,NGSINHHS,GIOITINHHS,DIACHIHS,DIENTHOAIHS,DANTOC,NGNHAPHOC,HINHANHHS FROM HOCSINH  WHERE DANTOC=@DANTOC 
	END
	Go
	
--TIM HOC SINH THEO NGAY NHAP HOPC	
create proc SP_TimHocSinhNgNhapHoc
@NGNHAPHOC SMALLDATETIME
AS
	BEGIN
		SELECT MAHS,TENHS,NGSINHHS,GIOITINHHS,DIACHIHS,DIENTHOAIHS,DANTOC,NGNHAPHOC,HINHANHHS FROM HOCSINH  WHERE NGNHAPHOC=@NGNHAPHOC 
	END
	GO
/*///////////////////////////////////////////////////////////////////////////////////// */
 
--THONG TIN PHAN LOP THEO MANH -------------------------------------------------------
CREATE PROC SP_ThongTinPhanLop
@MANH VARCHAR(6)
AS
BEGIN
SELECT PL.MANH,PL.MAHS,PL.MALOP, HS.TENHS, L.TenLop fROM HOCSINH HS INNER JOIN HOCLOP PL ON HS.MAHS = PL.MAHS INNER JOIN LOP L ON L.MALOP = PL.MALOP WHERE PL.MANH=@MANH
END
GO

--THONG TIN HOC SINH CHUA DUOC PHAN LOP theo NAM HOC
CREATE PROC SP_ThongTinHocSinhChuaPhanLop
@MANH VARCHAR(6)
AS
BEGIN
declare @NH varchar(2)
SET @NH=(SELECT LEFT(RIGHT(@MANH,4),2))
SELECT HS.MAHS,HS.TENHS FROM HOCSINH HS 
	WHERE HS.MAHS NOT IN (SELECT MAHS FROM HOCLOP WHERE MANH=@MANH)
		AND (SELECT RIGHT(LEFT(HS.MAHS,4),2))=@NH
END
GO

--THONG TIN PHAN LOP HOC SINH THE MANH VA MALOP
CREATE PROC SP_PhanLop
@MANH VARCHAR(6),@MALOP VARCHAR(10)
AS
BEGIN
SELECT PL.MANH,PL.MAHS,PL.MALOP, HS.TENHS, L.TenLop fROM HOCSINH HS INNER JOIN HOCLOP PL ON HS.MAHS = PL.MAHS INNER JOIN LOP L ON L.MALOP = PL.MALOP WHERE PL.MANH=@MANH AND PL.MALOP=@MALOP
END
GO

--THEM PHAN LOP HOC SINH
CREATE PROC SP_ThemPhanLop
@MANH VARCHAR(6),@MALOP VARCHAR(10),@MAHS VARCHAR(8),@THOIGIANHIEULUC SMALLDATETIME
AS
BEGIN
INSERT INTO HOCLOP VALUES(@MAHS,@MANH,@MALOP,@THOIGIANHIEULUC)
END
GO


--XOA PHAN LOP HOC SINH
CREATE PROC SP_XoaPhanLop
@MANH VARCHAR(6),@MALOP VARCHAR(10),@MAHS VARCHAR(8)
AS
BEGIN
DELETE FROM HOCLOP WHERE MAHS=@MAHS AND MANH=@MANH AND MALOP=@MALOP
END
GO
--====================================== KHOI =================================================

--THONG TIN KHOI
CREATE PROC SP_ThongTinKhoi
AS
BEGIN
SELECT * FROM KHOI
END
GO

--SUA KHOI
CREATE PROC SP_SuaKhoi
@MAKHOI VARCHAR(10),@TENKHOI NVARCHAR(15)
AS
BEGIN
UPDATE KHOI SET TENKHOI=@TENKHOI WHERE MAKHOI=@MAKHOI
END
GO

--THONG TIN KHOI TRONG MUC PHAN LOP
CREATE PROC SP_HienThiKhoi
@MAKHOI VARCHAR(10)
AS
BEGIN
IF @MAKHOI='K10'
BEGIN
SELECT MAKHOI,TENKHOI FROM KHOI WHERE MAKHOI='K10' OR MAKHOI='K11'
END
ELSE IF @MAKHOI='K11'
BEGIN 
SELECT MAKHOI,TENKHOI FROM KHOI WHERE MAKHOI='K11' OR MAKHOI='K12'
END
ELSE
SELECT MAKHOI,TENKHOI FROM KHOI WHERE MAKHOI='K12'
END
GO

--HIEN THI KHOI TORNG MUC CHUYEN LOP
CREATE PROC SP_HienThiKhoiChuyenLop
@MAKHOI VARCHAR(10)
AS
BEGIN
IF @MAKHOI='K10'
BEGIN
SELECT MAKHOI,TENKHOI FROM KHOI WHERE MAKHOI='K10'
END
ELSE IF @MAKHOI='K11'
BEGIN 
SELECT MAKHOI,TENKHOI FROM KHOI WHERE MAKHOI='K11'
END
ELSE
SELECT MAKHOI,TENKHOI FROM KHOI WHERE MAKHOI='K12'
END
GO

--THONG TIN KHOI 10
CREATE PROC SP_HienThiKhoi10
AS
BEGIN
SELECT MAKHOI,TENKHOI FROM KHOI WHERE MAKHOI='K10' 
END
go
--====================================== LOAIDIEM =================================================
--THONG TIN LOAIDIEM
CREATE PROC SP_ThongTinLoaiDiem
AS
BEGIN
SELECT * FROM LOAIDIEM
END
GO

--THEM LOAIDIEM
CREATE PROC SP_ThemLoaiDiem
@MALD VARCHAR(15),@TENLD NVARCHAR(20),@HESOLD CHAR(1)
AS
BEGIN
INSERT INTO LOAIDIEM VALUES(@MALD,@TENLD,@HESOLD)
END
GO

--SUA LOAIDIEM
CREATE PROC SP_SuaLoaiDiem
@MALD VARCHAR(15),@TENLD NVARCHAR(20),@HESOLD CHAR(1)
AS
BEGIN
UPDATE LOAIDIEM SET TENLD=@TENLD,HESOLD=@HESOLD WHERE MALD=@MALD
END
GO

--XOA LOAIDIEM
CREATE PROC SP_XoaLoaiDiem
@MALD VARCHAR(15)
AS
BEGIN
DELETE FROM LOAIDIEM WHERE MALD=@MALD
END
GO

--HE SO LOAIDIEM
CREATE PROC SP_HeSoLoaiDiem
@MALD VARCHAR(15)
AS
BEGIN
SELECT HESOLD FROM LOAIDIEM where MALD=@MALD
END
GO

--====================================== LOAIHANHKIEM =================================================
--THONG TIN LOAIHANHKIEM
CREATE PROC SP_ThongTinLoaiHanhKiem
AS
BEGIN
SELECT * FROM LOAIHANHKIEM
END
GO

--THEM LOAIHANHKIEM
CREATE PROC SP_ThemLoaiHanhKiem
@MALHK VARCHAR(15),@TENLHK NVARCHAR(20)
AS
BEGIN
INSERT INTO LOAIHANHKIEM VALUES(@MALHK,@TENLHK)
END
GO

--SUA LOAIHANHKIEM
CREATE PROC SP_SuaLoaiHanhKiem
@MALHK VARCHAR(15),@TENLHK NVARCHAR(20)
AS
BEGIN
UPDATE LOAIHANHKIEM SET TENLHK=@TENLHK WHERE MALHK=@MALHK
END
GO

--XOA LOAIHANHKIEM
CREATE PROC SP_XoaLoaiHanhKiem
@MALHK VARCHAR(15)
AS
BEGIN
DELETE FROM LOAIHANHKIEM WHERE MALHK=@MALHK
END
GO
--====================================== LOAINGUOIDUNG =================================================
--THONG TIN LOAINGUOIDUNG
CREATE PROC SP_ThongTinLoaiNguoiDung
AS
BEGIN
SELECT * FROM LOAINGUOIDUNG
END
GO

--THEM LOAINGUOIDUNG
CREATE PROC SP_ThemLoaiNguoiDung
@MALND VARCHAR(10),@TENLND NVARCHAR(20)
AS
BEGIN
INSERT INTO LOAINGUOIDUNG VALUES(@MALND,@TENLND)
END
GO

--SUA LOAINGUOIDUNG
CREATE PROC SP_SuaLoaiNguoiDung
@MALND VARCHAR(10),@TENLND NVARCHAR(20)
AS
BEGIN
UPDATE LOAINGUOIDUNG SET TENLND=@TENLND WHERE MALND=@MALND
END
GO

--XOA LOAINGUOIDUNG
CREATE PROC SP_XoaLoaiNguoiDung
@MALND VARCHAR(10)
AS
BEGIN
DELETE FROM LOAINGUOIDUNG WHERE MALND=@MALND
END
GO

--====================================== MONHOC =================================================

--THONG TIN MONHOC
CREATE PROC SP_ThongTinMonHoc
AS
BEGIN
SELECT * FROM MONHOC
END
GO

--THONG TIN SO DONG TRONG TABLE
CREATE PROC SP_ThongTinSoMon
AS
BEGIN
select right((select top(1) MAMH from MONHOC order by MAMH desc),2) 
END
GO

--THEM MONHOC
CREATE PROC SP_ThemMonHoc
@MAMH VARCHAR(10),@TENMH NVARCHAR(25),@SOTIET CHAR(2)
AS
BEGIN
INSERT INTO MONHOC VALUES(@MAMH,@TENMH,@SOTIET)
END
GO

--SUA MONHOC
CREATE PROC SP_SuaMonHoc
@MAMH VARCHAR(10),@TENMH NVARCHAR(25),@SOTIET CHAR(2)
AS
BEGIN
UPDATE MONHOC SET TENMH=@TENMH,SOTIET=@SOTIET WHERE MAMH=@MAMH
END
GO

--XOA MONHOC
CREATE PROC SP_XoaMonHoc
@MAMH VARCHAR(10)
AS
BEGIN
DELETE FROM MONHOC WHERE MAMH=@MAMH
END
GO

--====================================== HOCKY =================================================
--THONG TIN HOCKY
CREATE PROC SP_ThongTinHocKy
AS
BEGIN
SELECT distinct MAHK,TENHK FROM HOCKY
END
GO

--====================================== NAMHOC =================================================
--THONG TIN NAMHOC
CREATE PROC SP_ThongTinNamHoc
AS
BEGIN
SELECT * FROM NAMHOC ORDER BY MANH DESC
END
GO

--SUA NAMHOC
CREATE PROC SP_SuaNamHoc
@MANH VARCHAR(6),@TENNH NVARCHAR(30)
AS
BEGIN
UPDATE NAMHOC SET TENNH=@TENNH WHERE MANH=@MANH
END
GO

--THEM NAMHOC
CREATE PROC SP_ThemNamHoc
@MANH VARCHAR(6),@TENNH NVARCHAR(30)
AS
BEGIN
INSERT INTO NAMHOC VALUES(@MANH,@TENNH)
INSERT INTO HOCKY VALUES(@MANH,'HK1',N'Học kỳ 1')
INSERT INTO HOCKY VALUES(@MANH,'HK2',N'Học kỳ 2')
END
GO

--XOA NAMHOC
CREATE PROC SP_XoaNamHoc
@MANH VARCHAR(6)
AS
BEGIN
DELETE FROM NAMHOC WHERE MANH=@MANH
END
GO
--====================================== GIAOVIEN =================================================
--THONG TIN GIAOVIEN
CREATE PROC SP_ThongTinGiaoVien
AS
BEGIN
SELECT * FROM GIAOVIEN
END
GO

--THONG TIN SO DONG TRONG TABLE DE TAO MAGV
CREATE PROC SP_ThongTinSoGiaoVien
AS
BEGIN
select right((select top(1) MAGV from GIAOVIEN order by MAGV desc),3) 
END
GO

--THEM GIAOVIEN
CREATE PROC SP_ThemGiaoVien
@MAGV CHAR(5),@TENGV NVARCHAR(50),@NGSINHGV SMALLDATETIME,@GIOITINHGV CHAR(1),@DIACHIGV NVARCHAR(50),@DIENTHOAIGV VARCHAR(15),@HINHANHGV VARCHAR(200),@MABM VARCHAR(10)
AS
BEGIN
INSERT INTO GIAOVIEN VALUES(@MAGV,@TENGV,@NGSINHGV,@GIOITINHGV,@DIACHIGV,@DIENTHOAIGV,@HINHANHGV,@MABM)
END
GO

--SUA GIAOVIEN
CREATE PROC SP_SuaGiaoVien
@MAGV CHAR(5),@TENGV NVARCHAR(50),@NGSINHGV SMALLDATETIME,@GIOITINHGV CHAR(1),@DIACHIGV NVARCHAR(50),@DIENTHOAIGV VARCHAR(15),@HINHANHGV VARCHAR(200),@MABM VARCHAR(10)
AS
BEGIN
UPDATE GIAOVIEN SET TENGV=@TENGV,NGSINHGV=@NGSINHGV,GIOITINHGV=@GIOITINHGV,DIACHIGV=@DIACHIGV,DIENTHOAIGV=@DIENTHOAIGV,HINHANHGV=@HINHANHGV,MABM=@MABM WHERE MAGV=@MAGV
END
GO

--XOA GIAOVIEN
CREATE PROC SP_XoaGiaoVien
@MAGV CHAR(5)
AS
BEGIN
DELETE FROM GIAOVIEN WHERE MAGV=@MAGV
END
GO

--TIM GIAOVIEN THEO MAGV
CREATE PROC SP_TimGiaoVienMaGV
@MAGV CHAR(5)
AS
BEGIN
SELECT * FROM GIAOVIEN WHERE MAGV=@MAGV
END
GO

--TIM GIAOVIEN THEO TENGV
CREATE PROC SP_TimGiaoVienTenGV
@TENGV NVARCHAR(50)
AS
BEGIN
SELECT * FROM GIAOVIEN WHERE TENGV=@TENGV
END
GO

--TIM GIAOVIEN THEO Bo Mon
CREATE PROC SP_TimGiaoVienBM
@MABM VARCHAR(10)
AS
BEGIN
SELECT * FROM GIAOVIEN WHERE MABM=@MABM
END
GO
--====================================== LOP =================================================

--THONG TIN LOP
CREATE PROC SP_ThongTinLop
AS
BEGIN
SELECT * FROM LOP
END
GO


--DanhsachlopMAKHOI
CREATE PROC SP_DanhSachLopMAKHOI
@MAKHOI VARCHAR(10)
AS
	BEGIN
		SELECT MALOP,TENLOP FROM LOP WHERE MAKHOI=@MAKHOI
	END
GO

--THONG TIN LOP THEO MAHS , MANH --------------------------------------------------------
CREATE PROC SP_ThongTinLopMaHSMaNH
@MAHS VARCHAR(8),@MANH VARCHAR(6)
AS
BEGIN
SELECT LOP.MALOP FROM LOP INNER JOIN HOCLOP ON HOCLOP.MALOP=LOP.MALOP WHERE HOCLOP.MAHS=@MAHS AND HOCLOP.MANH=@MANH
END
GO

--SUA LOP
CREATE PROC SP_SuaLop
@MAKHOI VARCHAR(10),@MANH VARCHAR(6),@MALOP VARCHAR(10),@TENLOP NVARCHAR(20),@SISO VARCHAR(3),@MAGV CHAR(5),@MABAN VARCHAR(10)
AS
BEGIN
UPDATE LOP SET MAKHOI=@MAKHOI,TENLOP=@TENLOP,SISO=@SISO,MAGV=@MAGV,MABAN=@MABAN,MANH=@MANH WHERE  MALOP=@MALOP
END
GO

--THEM LOP
CREATE PROC SP_ThemLop
@MAKHOI VARCHAR(10),@MANH VARCHAR(6),@MALOP VARCHAR(10),@TENLOP NVARCHAR(20),@SISO VARCHAR(3),@MAGV CHAR(5),@MABAN VARCHAR(10)
AS
BEGIN
INSERT INTO LOP VALUES(@MALOP,@MAKHOI,@MANH,@MAGV,@TENLOP,@SISO,@MABAN)
END
GO

--XOA LOP
CREATE PROC SP_XoaLop
@MANH VARCHAR(6),@MALOP VARCHAR(10)
AS
BEGIN
DELETE FROM LOP  WHERE MANH=@MANH AND MALOP=@MALOP
END
GO


/*//////////////////////////////////////////////////////////////////////////////// */
/*Form khác */

--CHON LOP 10
CREATE PROC SP_ThongTinLop10
@MANH VARCHAR(6)
AS
BEGIN
select MALOP,TENLOP FROM LOP WHERE MAKHOI='K10' AND MANH=@MANH
END
GO

--Thong tin Si So Lop
CREATE PROC SP_ThongTinSiSoLop
@MALOP VARCHAR(10)
AS
BEGIN
select SISO from LOP where MALOP=@MALOP
END
GO

--DEM LOP
CREATE PROC SP_ThongTinSoLop
@NAM CHAR(4)
AS
BEGIN
select right((select top(1) MALOP from LOP WHERE MALOP LIKE '%'+RIGHT(@NAM,2)+'%' order by MALOP desc),2) 
END
GO

--THONG TIN LOP THEO NAM HOC
CREATE PROC SP_ThongTinLopNamHoc
@MANH VARCHAR(6)
AS
BEGIN
select MAKHOI,MALOP,TENLOP FROM LOP WHERE MANH=@MANH
END
GO

--DANH SACH LOP THEO MA KHOI MANH
CREATE PROC SP_DanhSachLopMAKHOIMANH
@MANH VARCHAR(6),@MAKHOI VARCHAR(10)
AS
BEGIN
select * FROM LOP WHERE MANH=@MANH and MAKHOI=@MAKHOI 
END
GO

--THONG TIN PHAN BAN
CREATE PROC SP_ThongTinPhanBanTheoLop
@MALOP VARCHAR(10)
AS
BEGIN
select MABAN FROM LOP WHERE MALOP=@MALOP
END
GO
--====================================== DIEM =================================================
	
--Them diem theo hoc sinh
CREATE PROC SP_ThemDiemTheoHS
@MALD VARCHAR(15),@MAHK VARCHAR(10),@MANH VARCHAR(6),@MAHS VARCHAR(8),@MAMH VARCHAR(10),@DIEMSO VARCHAR(4)
AS
BEGIN
insert into DIEM values(@MALD,@MAHK,@MANH,@MAHS,@MAMH,@DIEMSO)
END
GO

--Dem so lan xuat hien cua loai diem ...
CREATE PROC SP_DemDiem
@MALD VARCHAR(15),@MAHK VARCHAR(10),@MANH VARCHAR(6),@MAHS VARCHAR(8),@MAMH VARCHAR(10)
AS
BEGIN
select count(*) from DIEM where MALD=@MALD AND MAHK=@MAHK AND MANH=@MANH AND MAHS=@MAHS AND MAMH=@MAMH
END
go

--Sua diem theo hoc sinh
CREATE PROC SP_SuaDiemTheoHS
@STT int,@DIEMSO VARCHAR(4)
AS
BEGIN
update DIEM set DIEMSO=@DIEMSO where STT=@STT
END
go

--thong tin diem theo hoc sinh
CREATE PROC SP_ThongTinDiemTheoHS
@MALD VARCHAR(15),@MAHK VARCHAR(10),@MANH VARCHAR(6),@MAHS VARCHAR(8),@MAMH VARCHAR(10)
AS
BEGIN
select DIEM.STT,DIEM.MALD,DIEM.MAHK,DIEM.MANH,DIEM.MAHS,DIEM.MAMH,DIEM.DIEMSO,HS.TENHS,HOCLOP.MALOP 
FROM DIEM,HOCSINH HS,HOCLOP WHERE HS.MAHS=DIEM.MAHS and  HOCLOP.MAHS=DIEM.MAHS and HOCLOP.MANH=DIEM.MANH
AND MALD=@MALD AND MAHK=@MAHK AND DIEM.MANH=@MANH AND DIEM.MAHS=@MAHS AND MAMH=@MAMH
END
go

--THONG TIN MAS THEO LOP
CREATE PROC SP_ThongTinMaHSTheoLop
@MANH VARCHAR(6),@MALOP VARCHAR(10)
AS
BEGIN
 IF (EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE 
     TABLE_NAME = 'temp'))
    BEGIN
        DROP TABLE temp;
    END
select a.MAHS,a.THOIGIANHIEULUC into temp FROM HOCLOP a WHERE a.THOIGIANHIEULUC IN(select max(thoigianhieuluc) from HOCLOP  group by manh,MAHS)
IF (EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE 
     TABLE_NAME = 'temp1'))
    BEGIN
        DROP TABLE temp1;
    END
select hoclop.MAHS,MALOP,MANH,HOCLOP.THOIGIANHIEULUC into temp1  from temp inner join HOCLOP on temp.mahs=HOCLOP.MAHS and temp.thoigianhieuluc=HOCLOP.THOIGIANHIEULUC
 and HOCLOP.THOIGIANHIEULUC=temp.THOIGIANHIEULUC
SELECT HOCSINH.MAHS,TENHS FROM HOCSINH,LOP,temp1 WHERE HOCSINH.MAHS=temp1.MAHS and LOP.MANH=temp1.MANH and LOP.MALOP=temp1.MALOP AND LOP.MANH=@MANH AND LOP.MALOP=@MALOP
END
GO

--Danh sach HOC SINH theo MALD
CREATE PROC SP_ThongTinDiemHSTheoMaLD
@MANH VARCHAR(6),@MALD VARCHAR(15),@MAHK VARCHAR(10),@MAMH VARCHAR(10),@MAHS VARCHAR(8)
AS
BEGIN
SELECT DIEMSO FROM DIEM WHERE MALD=@MALD AND MAMH=@MAMH AND MAHS=@MAHS AND MAHK=@MAHK AND MANH=@MANH
END
GO

--xoa diem HOC SINH theo MALD
CREATE PROC SP_XoaDiemHSTheoMaLD
@MANH VARCHAR(6),@MALD VARCHAR(15),@MAHK VARCHAR(10),@MAMH VARCHAR(10),@MAHS VARCHAR(8)
AS
BEGIN
DELETE FROM DIEM WHERE MALD=@MALD AND MAMH=@MAMH AND MAHS=@MAHS AND MAHK=@MAHK AND MANH=@MANH
END
GO

--diem tb mon hoc hk
CREATE PROC SP_DiemTBTheoHocKiMonHoc
@MANH VARCHAR(6),@MAHK VARCHAR(10),@MAMH VARCHAR(10),@MAHS VARCHAR(8)
AS
BEGIN
SELECT MALD,DIEMSO FROM DIEM WHERE  MAMH=@MAMH AND MAHS=@MAHS AND MAHK=@MAHK AND MANH=@MANH
END
GO
--====================================== NGUOIDUNG =================================================

--THONG TIN SO DONG TRONG TABLE
CREATE PROC SP_ThongTinSoNguoiDung
AS
BEGIN
select right((select top(1) MAND from NGUOIDUNG order by MAND desc),3) 
END
GO

--THONG TIN NGUOIDUNG
CREATE PROC SP_ThongTinNguoiDung
AS
BEGIN
SELECT * FROM NGUOIDUNG
END
GO

--THONG TIN NGUOIDUNG theo TENDN
CREATE PROC SP_ThongTinNguoiDungTheoTENDN
@TENDN VARCHAR(50)
AS
BEGIN
SELECT * FROM NGUOIDUNG WHERE TENDN=@TENDN
END
GO
--SELECT * FROM LOAINGUOIDUNG

--THEM NGUOIDUNG
CREATE PROC SP_ThemNguoiDung
@MAND CHAR(5),@TENND NVARCHAR(50),@MALND VARCHAR(10),@TENDN VARCHAR(40),@MATKHAU VARCHAR(20)
AS
BEGIN
INSERT INTO NGUOIDUNG VALUES(@MAND,@MALND,@TENND,@TENDN,@MATKHAU)
END
GO

--SUA NGUOIDUNG
CREATE PROC SP_SuaNguoiDung
@MAND CHAR(5),@TENND NVARCHAR(50),@MALND VARCHAR(10),@TENDN VARCHAR(40),@MATKHAU VARCHAR(20)
AS
BEGIN
UPDATE NGUOIDUNG SET TENND=@TENND,TENDN=@TENDN,MATKHAU=@MATKHAU, MALND=@MALND WHERE MAND=@MAND
END
GO

--SUA MAT KHAY
CREATE PROC SP_SuaMatKhau
@TENDN VARCHAR(40),@MATKHAU VARCHAR(20)
AS
BEGIN
UPDATE NGUOIDUNG SET MATKHAU=@MATKHAU  WHERE TENDN=@TENDN
END
GO

--XOA NGUOIDUNG
CREATE PROC SP_XoaNguoiDung
@MAND CHAR(5)
AS
BEGIN
DELETE FROM NGUOIDUNG WHERE MAND=@MAND
END
GO

--====================================== PHAN CONG GIANG DAY =================================================
--DANH SACH PHAN CONG
CREATE PROC SP_DanhSachPhanCong
AS
	BEGIN
		SELECT * FROM GIANGDAY
	END
GO
	
--THEM GIANG DAY
CREATE PROC SP_ThemGiangDay
@MAMH VARCHAR(10),@MAGV CHAR(5),@MANH VARCHAR(6),@MALOP VARCHAR(10)
AS
	BEGIN
		INSERT INTO GIANGDAY VALUES(@MAMH,@MAGV,@MANH,@MALOP)
	END
GO

--XOA GIANG DAY
CREATE PROC SP_XoaGiangDay
@MAMH VARCHAR(10),@MAGV CHAR(5),@MANH VARCHAR(6),@MALOP VARCHAR(10)
AS
	BEGIN
		DELETE FROM GIANGDAY WHERE MAMH=@MAMH AND MAGV=@MAGV AND MANH=@MANH AND MALOP=@MALOP
	END
GO

--SUA GIANG DAY
CREATE PROC SP_SuaGiangDay
@MAMH VARCHAR(10),@MAGV CHAR(5),@MANH VARCHAR(6),@MALOP VARCHAR(10),@MAMH1 VARCHAR(10),@MAGV1 CHAR(5),@MANH1 VARCHAR(6),@MALOP1 VARCHAR(10)
AS
BEGIN
UPDATE GIANGDAY SET MAMH=@MAMH,MAGV=@MAGV,MANH=@MANH,MALOP=@MALOP WHERE MAMH=@MAMH1 AND MAGV=@MAGV1 AND MANH=@MANH1 AND MALOP=@MALOP1
END
GO

--Tim giang day
CREATE PROC SP_TimGiangDay
@TENGV NVARCHAR(50),@TENLOP NVARCHAR(20)
AS
	BEGIN
	IF(LEN(@TENGV)!=0)
		BEGIN
			SELECT MALOP,GIAOVIEN.MAGV,MAMH,MANH FROM GIANGDAY,GIAOVIEN WHERE GIANGDAY.MAGV=GIAOVIEN.MAGV AND TENGV=@TENGV
		END
	IF(LEN(@TENLOP)!=0)
		BEGIN
			SELECT	LOP.MALOP,GIANGDAY.MAGV,MAMH,GIANGDAY.MANH FROM GIANGDAY,LOP WHERE GIANGDAY.MALOP=LOP.MALOP AND TENLOP=@TENLOP
		END
	END
GO
--====================================== HANH KIEM =================================================

--LOC NHUNG HOC SINH CHUA NHAP HANH KIEM DE HIEN THI LEN DATAGRID
CREATE PROC SP_DanhSachHocSinh_LOP_NAMHOC_HOCKY
@MALOP VARCHAR(10),@MANH VARCHAR(6),@MAHK VARCHAR(10)
AS
	BEGIN
		SELECT HOCSINH.MAHS,TENHS,NAMHOC.MANH,MAHK FROM HOCSINH,HOCLOP,NAMHOC,HOCKY WHERE HOCSINH.MAHS=HOCLOP.MAHS AND HOCLOP.MANH=NAMHOC.MANH AND HOCKY.MANH=NAMHOC.MANH AND NAMHOC.MANH=@MANH AND MAHK=@MAHK AND HOCLOP.MALOP=@MALOP AND HOCSINH.MAHS NOT IN(SELECT MAHS FROM HANHKIEM WHERE MANH=@MANH AND MAHK=@MAHK)
	END
GO

--Danh sach hanh kiem
CREATE PROC SP_DanhSachHanhKiem
@MALOP VARCHAR(10),@MANH VARCHAR(6),@MAHK VARCHAR(10)
AS
	BEGIN
		SELECT HOCSINH.MAHS,TENHS,HANHKIEM.MANH,MAHK,MALHK FROM HOCSINH,HANHKIEM,HOCLOP WHERE HOCSINH.MAHS=HANHKIEM.MAHS AND HOCSINH.MAHS=HOCLOP.MAHS AND MAHK=@MAHK AND HANHKIEM.MANH=@MANH AND MALOP=@MALOP
	END
GO

--THEM HANH KIEM
CREATE PROC SP_ThemHanhKiem
@MALHK VARCHAR(15),@MAHS VARCHAR(8),@MANH VARCHAR(6),@MAHK VARCHAR(10)
AS
	BEGIN
		INSERT INTO HANHKIEM VALUES(@MALHK,@MAHS,@MANH,@MAHK)
	END
Go

--SUA HANH KIEM
CREATE PROC SP_SuaHanhKiem
@MALHK VARCHAR(15),@MAHS VARCHAR(8),@MANH VARCHAR(6),@MAHK VARCHAR(10)
AS
	BEGIN
		UPDATE HANHKIEM SET MALHK=@MALHK WHERE MAHS=@MAHS AND MANH=@MANH AND MAHK=@MAHK
	END
GO

	--TIM HK MAHS,MANH,MAHK
CREATE PROC SP_TimHanhKiem_MAHS_MANH_MAHK
@MAHS VARCHAR(10),@MANH VARCHAR(6),@MAHK VARCHAR(10)
AS
	BEGIN
		SELECT * FROM HANHKIEM WHERE MAHS=@MAHS AND MANH=@MANH AND MAHK=@MAHK
	END
GO

--Hanh kiem hoc sinh theo hoc ky nam hoc
CREATE PROC SP_HanhKiemTheoHocKiNamHoc
@MANH VARCHAR(6),@MAHK VARCHAR(10),@MAHS VARCHAR(8)
AS
BEGIN
SELECT HANHKIEM.MALHK,TENLHK FROM HANHKIEM INNER JOIN LOAIHANHKIEM ON HANHKIEM.MALHK=LOAIHANHKIEM.MALHK WHERE  MAHS=@MAHS AND MAHK=@MAHK AND MANH=@MANH
END
GO
	--Xoa hanh kiem
CREATE PROC SP_XoaHanhKiem
@MAHS VARCHAR(8),@MANH VARCHAR(6),@MAHK VARCHAR(10)
AS
	BEGIN
		DELETE FROM HANHKIEM WHERE MAHS=@MAHS AND MANH=@MANH AND MAHK=@MAHK
	END
GO

--====================================== BAN =================================================
CREATE PROC SP_ThongTinBan
AS
	BEGIN
		select * from BAN
	END
GO

--====================================== REPORT =================================================

--REPORT  DS LỚP
CREATE PROC SP_ReportDSLop
AS
BEGIN
select KHOI.TENKHOI,GIAOVIEN.TENGV,tenlop,siso,tenban,NAMHOC.TENNH,LOP.MANH 
	from LOP,GIAOVIEN,KHOI,NAMHOC,BAN 
	where LOP.MAGV=GIAOVIEN.MAGV and LOP.MAKHOI=KHOI.MAKHOI and LOP.MANH=NAMHOC.MANH and LOP.MABAN=BAN.MABAN 
END
GO	

--REPORT  DS GIAO VIEN
CREATE PROC SP_ReportDSGiaoVien
AS
BEGIN
select MAGV,TENGV,CONVERT(VARCHAR(11),NGSINHGV,103) as NGSINHGV,
(select case when GIOITINHGV=0 then N'Nam'
else N'Nữ' END) as GIOITINH,DIACHIGV,DIENTHOAIGV,TENBM
	from GIAOVIEN,BOMON where GIAOVIEN.MABM=BOMON.MABM
END
GO	

--REPORT THE HOC SINBH
CREATE PROC SP_ReportTheHocSinh
@MALOP VARCHAR(10)
AS
BEGIN
 IF (EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE 
     TABLE_NAME = 'temp'))
    BEGIN
        DROP TABLE temp;
    END
select a.MAHS,a.THOIGIANHIEULUC into temp FROM HOCLOP a WHERE a.THOIGIANHIEULUC IN(select max(thoigianhieuluc) from HOCLOP  group by manh,MAHS)
IF (EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE 
     TABLE_NAME = 'temp1'))
    BEGIN
        DROP TABLE temp1;
    END
select hoclop.MAHS,MALOP,MANH,HOCLOP.THOIGIANHIEULUC into temp1  from temp inner join HOCLOP on temp.mahs=HOCLOP.MAHS and temp.thoigianhieuluc=HOCLOP.THOIGIANHIEULUC
 and HOCLOP.THOIGIANHIEULUC=temp.THOIGIANHIEULUC
sELECT hocsinh.MAHS,TENHS,CONVERT(VARCHAR(11),NGSINHHS,103) as NGSINHHS,right(CONVERT(VARCHAR(11),NGNHAPHOC,103),4)+'-'+right(CONVERT(VARCHAR(11),dateadd(yyyy,3,NGNHAPHOC),103),4) AS NIENHOC,HINHANHHS FROM HOCSINH,LOP,temp1 WHERE HOCSINH.MAHS=temp1.MAHS and LOP.MANH=temp1.MANH and LOP.MALOP=temp1.MALOP AND  LOP.MALOP=@MALOP
END
GO

--REPORT DANH SACH HOC SINH THEO LOP
CREATE PROC SP_DanhSachHocSinh_NH_LOP 
@MANH VARCHAR(6),@MALOP VARCHAR(10)
 AS 
 BEGIN 
 SELECT HOCSINH.MAHS,HOCSINH.TENHS,NGSINHHS,GIOITINHHS,DIACHIHS,TENLOP,TENGV,TENNH,SISO,TENBAN 
 FROM HOCSINH,HOCLOP,NAMHOC,GIAOVIEN,LOP,BAN 
 WHERE HOCSINH.MAHS=HOCLOP.MAHS AND HOCLOP.MANH=NAMHOC.MANH AND HOCLOP.MALOP=LOP.MALOP AND LOP.MAGV=GIAOVIEN.MAGV AND LOP.MABAN=BAN.MABAN AND NAMHOC.MANH=@MANH AND LOP.MALOP=@MALOP
  END
  GO
  
--REPORT BANGDIEMHOCSINH
CREATE PROC SP_BANGDIEMHOCSINH
@MANH VARCHAR(6),@MALOP VARCHAR(10),@MAHS VARCHAR(8)
AS
BEGIN
	SELECT MAHS,TENHS,TENLOP,TENNH,TENMH,[Học kỳ 1],[Học kỳ 2],CONVERT(DECIMAL(4,1),([Học kỳ 1]+[Học kỳ 2]*2)/3) AS CANAM,MALD,NGSINHHS,GIOITINHHS,TENBAN,MABAN,TENGV
	FROM
	(SELECT HOCSINH.MAHS,TENHK,TENLOP,TENHS,MONHOC.MAMH,TENMH,TENNH,CONVERT(FLOAT,DIEMSO)AS DIEMSO,MALD,NGSINHHS,GIOITINHHS,TENBAN,BAN.MABAN,TENGV
	FROM DIEM,HOCLOP,LOP,HOCSINH,NAMHOC,MONHOC,HOCKY,BAN,GIAOVIEN
	WHERE HOCSINH.MAHS=DIEM.MAHS AND LOP.MALOP=HOCLOP.MALOP AND DIEM.MANH=NAMHOC.MANH AND DIEM.MAMH=MONHOC.MAMH AND HOCSINH.MAHS=HOCLOP.MAHS AND HOCKY.MAHK=DIEM.MAHK  AND GIAOVIEN.MAGV=LOP.MAGV AND LOP.MABAN=BAN.MABAN AND NAMHOC.MANH=@MANH AND LOP.MALOP=@MALOP AND HOCSINH.MAHS=@MAHS AND MALD='LD05') sourceTable
	PIVOT
	( MAX(DIEMSO) FOR TENHK IN([Học kỳ 1],[Học kỳ 2])) PivotTable
END
GO

--REPORT HOC SINH GIOI THEO HOC KT
CREATE PROC SP_HSG
@MANH VARCHAR(6),@MAHK VARCHAR(10),@MALOP VARCHAR(10)
AS 
BEGIN 
select TENGV,TENNH,TENHS,TENLOP,TENLHK,TENBAN,
  [Toán], [Lý],[Hóa], [Sinh],[Văn], [Anh],[Sử], [Địa],[GDCD],[Công nghệ], [Tin học],[GDQP], [Thể dục],TENHK
from
(
  SELECT 
     TENHK,TENGV,TENNH,TENHS,TENLOP,TENLHK,TENBAN,TENMH,DIEMSO
  FROM DIEM,MONHOC,HOCSINH,LOP,HANHKIEM,LOAIHANHKIEM,HOCLOP,NAMHOC,GIAOVIEN,BAN,HOCKY 
  WHERE BAN.MABAN=LOP.MABAN AND GIAOVIEN.MAGV=LOP.MAGV AND NAMHOC.MANH=HOCLOP.MANH 
  AND DIEM.MANH=NAMHOC.MANH AND HOCLOP.MAHS=DIEM.MAHS AND HOCLOP.MALOP=LOP.MALOP 
  AND HOCLOP.MANH=LOP.MANH AND HANHKIEM.MALHK=LOAIHANHKIEM.MALHK and HANHKIEM.MAHK=DIEM.MAHK and HANHKIEM.MANH=DIEM.MANH 
  AND MONHOC.MAMH=DIEM.MAMH AND HOCSINH.MAHS=DIEM.MAHS and DIEM.MAHS=HANHKIEM.MAHS
  AND DIEM.MAHK=HOCKY.MAHK AND 
  MALD='LD05' AND HOCLOP.MALOP=@MALOP and DIEM.MANH=@MANH AND DIEM.MAHK=@MAHK
) d
pivot
(
  max(DIEMSO)
  for TENMH in ([Toán], [Lý],[Hóa], [Sinh],[Văn], [Anh],[Sử], [Địa],[GDCD],[Công nghệ], [Tin học],[GDQP], [Thể dục])
) piv;
END
GO



--REPORT HCO SINH LUU BAN THEO NAM HOC
CREATE PROC SP_LuuBan
@MANH VARCHAR(6),@MAHK VARCHAR(10),@MAKHOI VARCHAR(10)
AS 
BEGIN 
select TENNH,TENHS,TENLOP,TENLHK,MABAN,
  [Toán], [Lý],[Hóa], [Sinh],[Văn], [Anh],[Sử], [Địa],[GDCD],[Công nghệ], [Tin học],[GDQP], [Thể dục],MAHS
from
(
	SELECT TENNH,TENHS,TENLOP,TENLHK,MABAN,DIEM.MAHS,TENMH,DIEMSO
	FROM LOP,HOCLOP,DIEM,MONHOC,GIAOVIEN,HANHKIEM,HOCSINH,LOAIHANHKIEM,NAMHOC WHERE 
	DIEM.MANH=NAMHOC.MANH AND
	  HANHKIEM.MAHS=DIEM.MAHS AND GIAOVIEN.MAGV=LOP.MAGV AND MONHOC.MAMH=DIEM.MAMH 
	AND HOCLOP.MALOP=LOP.MALOP AND HOCLOP.MAHS=HOCSINH.MAHS 
	AND HOCSINH.MAHS=DIEM.MAHS AND HANHKIEM.MALHK=LOAIHANHKIEM.MALHK and HANHKIEM.MAHK=DIEM.MAHK and HANHKIEM.MAHS=diem.MAHS and HANHKIEM.MANH=DIEM.MANH 
	AND DIEM.MALD='LD05'  AND DIEM.MAHK=@MAHK  AND MAKHOI=@MAKHOI AND NAMHOC.MANH=@MANH
) d
pivot
(
  max(DIEMSO)
  for TENMH in ([Toán], [Lý],[Hóa], [Sinh],[Văn], [Anh],[Sử], [Địa],[GDCD],[Công nghệ], [Tin học],[GDQP], [Thể dục])
) piv;
END
GO

--REPORT DANH SACH CAC NAM HOC CUA MOT HOC SINH
create proc SP_DanhSachCacNamHoc
@MAHS VARCHAR(8)
AS
BEGIN
select * FROM HOCLOP a  WHERE a.MAHS=@MAHS AND a.THOIGIANHIEULUC IN(select max(thoigianhieuluc) from HOCLOP  group by manh,MAHS) ORDER BY MANH ASC
END
GO

--REPORT HOC BA
create proc SP_HocBaTheoNamHoc
@MAHS VARCHAR(8),@MANH VARCHAR(6),@MALOP VARCHAR(10)
as
begin 
select TENGV,TENNH,TENLOP,TENHS,MABAN,TENBAN,@MAHS AS MAHS,
[MH011],[MH012],[MH013],[MH021],[MH022],[MH023],[MH031],[MH032],[MH033],[MH041],[MH042],[MH043],[MH051],[MH052],[MH053],[MH061],[MH062],[MH063],[MH071],[MH072],[MH073],[MH081],[MH082],[MH083],[MH091],[MH092],[MH093],[MH101],[MH102],[MH103],[MH111],[MH112],[MH113],[MH121],[MH122],[MH123],[MH131],[MH132],[MH133],[TB1],[TB2],[TB3],[HK1],[HK2],[HK3],[HL1],[HL2],[HL3]
from
(
SELECT TENNH,TENHS,TENLOP,TENGV,lop.MABAN,TENBAN,MALD,DIEMSO
FROM LOP,HOCLOP,DIEM,GIAOVIEN,HOCSINH,NAMHOC,BAN WHERE 
DIEM.MANH=NAMHOC.MANH AND HOCSINH.MAHS=DIEM.MAHS AND BAN.MABAN=LOP.MABAN
AND HOCLOP.MALOP=LOP.MALOP AND HOCLOP.MAHS=HOCSINH.MAHS AND
HOCLOP.MALOP=@MALOP AND NAMHOC.MANH=@MANH AND DIEM.MAHS=@MAHS
) d
pivot
(
  max(DIEMSO)
  for MALD in ([MH011],[MH012],[MH013],[MH021],[MH022],[MH023],[MH031],[MH032],[MH033],[MH041],[MH042],[MH043],[MH051],[MH052],[MH053],[MH061],[MH062],[MH063],[MH071],[MH072],[MH073],[MH081],[MH082],[MH083],[MH091],[MH092],[MH093],[MH101],[MH102],[MH103],[MH111],[MH112],[MH113],[MH121],[MH122],[MH123],[MH131],[MH132],[MH133],[TB1],[TB2],[TB3],[HK1],[HK2],[HK3],[HL1],[HL2],[HL3]
)
) piv;

END
GO

--REPORT DIEM THEO MON HOC
CREATE PROC SP_DIEMTHEOMONHOC
@MANH VARCHAR(6),@MAHK VARCHAR(10),@MALOP VARCHAR(10),@MAMH VARCHAR(10)
AS 
BEGIN 
select TENHK,TENGV,TENNH,TENLOP,MAHS,TENHS,TENMH,
[LD011],[LD012],[LD021],[LD022],[LD023],[LD024],[LD025],[LD031],[LD032],[LD033],[LD034],[LD035],[LD041],[LD051]
from
(
SELECT TENHK,TENNH,TENHS,TENLOP,DIEM.MAHS,TENMH,TENGV,MALD,DIEMSO
FROM LOP,HOCLOP,DIEM,MONHOC,GIAOVIEN,GIANGDAY,HOCSINH,NAMHOC,HOCKY WHERE 
GIANGDAY.MAGV=GIAOVIEN.MAGV AND GIANGDAY.MANH=NAMHOC.MANH AND GIANGDAY.MALOP=HOCLOP.MALOP
AND GIANGDAY.MAMH=DIEM.MAMH AND DIEM.MAHK=HOCKY.MAHK AND
DIEM.MANH=NAMHOC.MANH AND HOCSINH.MAHS=DIEM.MAHS AND MONHOC.MAMH=DIEM.MAMH 
AND HOCLOP.MALOP=LOP.MALOP AND HOCLOP.MAHS=HOCSINH.MAHS 
AND DIEM.MAHK=@MAHK  AND HOCLOP.MALOP=@MALOP AND NAMHOC.MANH=@MANH AND DIEM.MAMH=@MAMH
) d
pivot
(
  max(DIEMSO)
  for MALD in ([LD011],[LD012],[LD021],[LD022],[LD023],[LD024],[LD025],[LD031],[LD032],[LD033],[LD034],[LD035],[LD041],[LD051])
) piv;
END
GO

----REPORT DIEM THEO MON HOC
--CREATE PROC SP_DIEMTHEOMONHOC
--@MANH VARCHAR(6),@MAHK VARCHAR(10),@MALOP VARCHAR(10),@MAMH VARCHAR(10)
--AS 
--BEGIN 
--select TENHK,TENGV,TENNH,TENLOP,MAHS,TENHS,TENMH,
--[LD011],[LD012],[LD021],[LD022],[LD023],[LD024],[LD025],[LD031],[LD032],[LD033],[LD034],[LD035],[LD041],[LD051]
--from
--(
--SELECT TENHK,TENNH,TENHS,TENLOP,DIEM.MAHS,TENMH,TENGV,MALD,DIEMSO
--FROM LOP,HOCLOP,DIEM,MONHOC,GIAOVIEN,GIANGDAY,HOCSINH,NAMHOC,HOCKY WHERE 
--GIANGDAY.MAGV=GIAOVIEN.MAGV AND GIANGDAY.MANH=NAMHOC.MANH AND GIANGDAY.MALOP=HOCLOP.MALOP
--AND GIANGDAY.MAMH=DIEM.MAMH AND DIEM.MAHK=HOCKY.MAHK AND
--DIEM.MANH=NAMHOC.MANH AND HOCSINH.MAHS=DIEM.MAHS AND MONHOC.MAMH=DIEM.MAMH 
--AND HOCLOP.MALOP=LOP.MALOP AND HOCLOP.MAHS=HOCSINH.MAHS 
--AND DIEM.MAHK=@MAHK  AND HOCLOP.MALOP=@MALOP AND NAMHOC.MANH=@MANH AND DIEM.MAMH=@MAMH
--) d
--pivot
--(
--  max(DIEMSO)
--  for MALD in ([LD011],[LD012],[LD021],[LD022],[LD023],[LD024],[LD025],[LD031],[LD032],[LD033],[LD034],[LD035],[LD041],[LD051])
--) piv;
--END
--GO


--====================================== BOMON   =================================================
	--DANH SACH BO MON
CREATE PROC SP_DanhSachBoMon
AS
	BEGIN
		SELECT * FROM BOMON
	END
GO
--====================================== GIATRI   =================================================
--insert into DIEM values('LD01','HK1','NH1314','20130000','MH01','7.2')
--insert into DIEM values('LD01','HK1','NH1314','20130000','MH01','7.3')
--insert into DIEM values('LD02','HK1','NH1314','20130000','MH01','6.8')
--insert into DIEM values('LD02','HK1','NH1314','20130000','MH01','8.5')
--insert into DIEM values('LD02','HK1','NH1314','20130000','MH01','8.0')
--insert into DIEM values('LD03','HK1','NH1314','20130000','MH01','5.9')
--insert into DIEM values('LD03','HK1','NH1314','20130000','MH01','8.4')
--insert into DIEM values('LD03','HK1','NH1314','20130000','MH01','7.1')
--insert into DIEM values('LD03','HK1','NH1314','20130000','MH01','8.0')
--insert into DIEM values('LD04','HK1','NH1314','20130000','MH01','8.2')
--insert into DIEM values('LD05','HK1','NH1314','20130000','MH01','7.4')

--insert into DIEM values('LD01','HK2','NH1314','20130000','MH01','7.2')
--insert into DIEM values('LD01','HK2','NH1314','20130000','MH01','7.3')
--insert into DIEM values('LD02','HK2','NH1314','20130000','MH01','6.8')
--insert into DIEM values('LD02','HK2','NH1314','20130000','MH01','8.5')
--insert into DIEM values('LD02','HK2','NH1314','20130000','MH01','8.0')
--insert into DIEM values('LD03','HK2','NH1314','20130000','MH01','5.9')
--insert into DIEM values('LD03','HK2','NH1314','20130000','MH01','8.4')
--insert into DIEM values('LD03','HK2','NH1314','20130000','MH01','7.1')
--insert into DIEM values('LD03','HK2','NH1314','20130000','MH01','8.0')
--insert into DIEM values('LD04','HK2','NH1314','20130000','MH01','8.2')
--insert into DIEM values('LD05','HK2','NH1314','20130000','MH01','7.4')
--select * from diem
--select * from hocsinh where MAHS='20130000'
--insert into DIEM values('LD05','HK2','NH1516','20130000','MH01','7.2')
--insert into DIEM values('LD05','HK2','NH1516','20130000','MH02','7.3')
--insert into DIEM values('LD05','HK2','NH1516','20130000','MH03','6.8')
--insert into DIEM values('LD05','HK2','NH1516','20130000','MH04','8.5')
--insert into DIEM values('LD05','HK2','NH1516','20130000','MH05','8.0')
--insert into DIEM values('LD05','HK2','NH1516','20130000','MH06','5.9')
--insert into DIEM values('LD05','HK2','NH1516','20130000','MH07','8.4')
--insert into DIEM values('LD05','HK2','NH1516','20130000','MH08','7.1')
--insert into DIEM values('LD05','HK2','NH1516','20130000','MH09','8.0')
--insert into DIEM values('LD05','HK2','NH1516','20130000','MH10','8.2')
--insert into DIEM values('LD05','HK2','NH1516','20130000','MH11','7.4')
--insert into DIEM values('LD05','HK2','NH1516','20130000','MH12','8.8')
--insert into DIEM values('LD05','HK2','NH1516','20130000','MH13','9.3')
--insert into LOP values('L1201','K10','NH1213','GV001','10A1',40,'CB')
--insert into LOP values('L1202','K10','NH1213','GV002','10A1',40,'KHTN')
--insert into LOP values('L1201','K10','NH1213','GV001','10A1',40,'CB')

insert into QUYDINH values('HK1',N'Học Kỳ 1','1')
insert into QUYDINH values('HK2',N'Học Kỳ 2','2')
insert into QUYDINH values('TuoiTT',N'Tuổi tối thiểu','15')
insert into QUYDINH values('TuoiTD',N'Tuổi tối đa','20')
insert into QUYDINH values('SiSoTT',N'Sỉ số tối thiểu','30')
insert into QUYDINH values('SiSoTD',N'Sỉ số tối đa','40')
insert into QUYDINH values('TenTruong',N'Tên trường',null)
insert into QUYDINH values('DiaChi',N'Địa chỉ',null)
insert into QUYDINH values('DienThoai',N'Điện thoại',null)
insert into KHOI VALUES('K10',N'KHỐI 10')
insert into KHOI VALUES('K11',N'KHỐI 11')
insert into KHOI VALUES('K12',N'KHỐI 12')
insert into loaidiem values('LD01',N'Miệng','1')
insert into loaidiem values('LD02',N'15 phút','1')
insert into loaidiem values('LD03',N'1tiết','2')
insert into loaidiem values('LD04',N'thi','3')
insert into loaidiem values('LD05',N'Trung bình',null)
insert into LOAIHANHKIEM VALUES('LHK1',N'Tốt')
insert into LOAIHANHKIEM VALUES('LHK2',N'Khá')
insert into LOAIHANHKIEM VALUES('LHK3',N'Trung bình')
insert into LOAIHANHKIEM VALUES('LHK4',N'Yếu')
insert into BAN values('B01',N'Ban cơ bản')
insert into BAN values('B02',N'Ban khoa học tự nhiên')
insert into BAN values('B03',N'Ban khao học xã hội và nhân văn')
insert into BOMON values('BM01',N'Văn')
insert into BOMON values('BM02',N'Lý')
insert into BOMON values('BM03',N'Hóa')
insert into BOMON values('BM04',N'Sinh-Công nghệ')
insert into BOMON values('BM05',N'Ngoại ngữ')
insert into BOMON values('BM06',N'Toán-Tin')
insert into BOMON values('BM07',N'Thể dục-GDQP')
insert into BOMON values('BM08',N'Sử-Địa')
INSERT INTO LOAINGUOIDUNG VALUES('ADMIN',N'Quản trị hệ thống')
--INSERT INTO LOAINGUOIDUNG VALUES('GIAOVU',N'Giaó vụ')
--INSERT INTO LOAINGUOIDUNG VALUES('GIAOVIEN',N'Giaó viên')
insert into nguoidung values('ND001','ADMIN','dang lien minh','admin','12345')
--insert into nguoidung values('ND002','GIAOVU','dang  minh','giaovu','12345')
--insert into nguoidung values('ND003','GIAOVIEN','lien minh','giaovien','12345')
--insert into HOCSINH values('20120000','dang lien minh','06-26-1993','1','mac dinh chi','0125811062','09-5-2012','C:\Users\uit11_000\Documents\Visual Studio 2012\Projects\QuanLiHocSinh2\QuanLiHocSinh\bin\Debug\hinhAnh\th.jpg','kinh')
--insert into HOCSINH values('20120001','phan thoai anh','5-30-1993','0','tran phu','0125811062','09-5-2012','C:\Users\uit11_000\Documents\Visual Studio 2012\Projects\QuanLiHocSinh2\QuanLiHocSinh\bin\Debug\hinhAnh\th.jpg','khmer')

